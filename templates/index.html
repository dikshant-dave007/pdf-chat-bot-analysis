<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>PDF Q&A Chat Agent</title>
      <style>
         * {
         margin: 0;
         padding: 0;
         box-sizing: border-box;
         }
         body {
         font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         min-height: 100vh;
         padding: 20px;
         color: #333;
         }
         .chat-container {
         max-width: 1200px;
         margin: 0 auto;
         background: white;
         border-radius: 15px;
         box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
         overflow: hidden;
         display: flex;
         flex-direction: column;
         height: 90vh;
         }
         .chat-header {
         background: linear-gradient(135deg, #0078d7, #106ebe);
         color: white;
         padding: 20px;
         text-align: center;
         }
         .chat-header h1 {
         font-size: 1.8rem;
         margin-bottom: 5px;
         }
         .chat-header p {
         opacity: 0.9;
         font-size: 0.9rem;
         }
         .main-content {
         display: flex;
         flex: 1;
         overflow: hidden;
         }
         .sidebar {
         width: 350px;
         background: #f8f9fa;
         border-right: 1px solid #e1e5e9;
         padding: 20px;
         overflow-y: auto;
         }
         .messages-container {
         flex: 1;
         overflow-y: auto;
         padding: 20px;
         background: #f8f9fa;
         }
         .message {
         margin-bottom: 20px;
         max-width: 80%;
         animation: fadeIn 0.3s ease;
         }
         @keyframes fadeIn {
         from { opacity: 0; transform: translateY(10px); }
         to { opacity: 1; transform: translateY(0); }
         }
         .user-message {
         margin-left: auto;
         }
         .bot-message {
         margin-right: auto;
         }
         .message-bubble {
         padding: 15px 20px;
         border-radius: 18px;
         line-height: 1.5;
         box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
         }
         .user-message .message-bubble {
         background: #0078d7;
         color: white;
         border-bottom-right-radius: 5px;
         }
         .bot-message .message-bubble {
         background: white;
         color: #333;
         border: 1px solid #e1e5e9;
         border-bottom-left-radius: 5px;
         }
         .message-sender {
         font-size: 0.8rem;
         font-weight: 600;
         margin-bottom: 5px;
         display: flex;
         align-items: center;
         gap: 5px;
         }
         .user-message .message-sender {
         justify-content: flex-end;
         color: #0078d7;
         }
         .bot-message .message-sender {
         color: #666;
         }
         .message-content {
         word-wrap: break-word;
         }
         .typing-indicator {
         display: inline-flex;
         align-items: center;
         gap: 5px;
         font-style: italic;
         color: #666;
         }
         .typing-dots {
         display: flex;
         gap: 3px;
         }
         .typing-dot {
         width: 6px;
         height: 6px;
         border-radius: 50%;
         background-color: #666;
         animation: typing 1.4s infinite ease-in-out;
         }
         .typing-dot:nth-child(1) { animation-delay: -0.32s; }
         .typing-dot:nth-child(2) { animation-delay: -0.16s; }
         @keyframes typing {
         0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
         40% { transform: scale(1); opacity: 1; }
         }
         .input-container {
         padding: 20px;
         background: white;
         border-top: 1px solid #e1e5e9;
         display: flex;
         gap: 10px;
         }
         #user-input {
         flex: 1;
         padding: 12px 15px;
         border: 2px solid #e1e5e9;
         border-radius: 8px;
         font-size: 1rem;
         transition: border-color 0.3s ease;
         }
         #user-input:focus {
         outline: none;
         border-color: #0078d7;
         }
         button {
         padding: 12px 20px;
         border: none;
         border-radius: 8px;
         font-weight: 600;
         cursor: pointer;
         transition: all 0.3s ease;
         display: flex;
         align-items: center;
         gap: 5px;
         }
         .send-btn {
         background: #0078d7;
         color: white;
         }
         .send-btn:hover {
         background: #106ebe;
         transform: translateY(-1px);
         box-shadow: 0 4px 8px rgba(0, 120, 215, 0.3);
         }
         .reset-btn {
         background: #d13438;
         color: white;
         }
         .reset-btn:hover {
         background: #b02a30;
         transform: translateY(-1px);
         box-shadow: 0 4px 8px rgba(209, 52, 56, 0.3);
         }
         .upload-btn {
         background: #107c10;
         color: white;
         width: 100%;
         }
         .upload-btn:hover {
         background: #0e6b0e;
         transform: translateY(-1px);
         box-shadow: 0 4px 8px rgba(16, 124, 16, 0.3);
         }
         .model-btn {
         background: #6f42c1;
         color: white;
         width: 100%;
         margin-bottom: 15px;
         }
         .model-btn:hover {
         background: #5e35b1;
         transform: translateY(-1px);
         box-shadow: 0 4px 8px rgba(111, 66, 193, 0.3);
         }
         .token-usage {
         padding: 15px 20px;
         background: #e7f3ff;
         border-top: 1px solid #c7e0f4;
         font-weight: 600;
         display: flex;
         align-items: center;
         gap: 8px;
         font-size: 0.9rem;
         }
         /* System Message Styles */
         .system-message-section {
         margin-bottom: 20px;
         padding: 15px;
         background: white;
         border-radius: 10px;
         border: 1px solid #e1e5e9;
         }
         .system-message-area {
         margin-top: 10px;
         }
         #system-message-input {
         width: 100%;
         padding: 12px;
         border: 2px solid #e1e5e9;
         border-radius: 8px;
         font-size: 0.9rem;
         font-family: inherit;
         resize: vertical;
         min-height: 80px;
         transition: border-color 0.3s ease;
         }
         #system-message-input:focus {
         outline: none;
         border-color: #0078d7;
         }
         .system-message-actions {
         display: flex;
         gap: 10px;
         margin-top: 10px;
         }
         .system-message-actions .action-btn {
         flex: 1;
         padding: 8px 12px;
         font-size: 0.8rem;
         }
         .current-system-message {
         margin-top: 10px;
         padding: 10px;
         background: #f8f9fa;
         border-radius: 5px;
         border-left: 3px solid #0078d7;
         font-size: 0.8rem;
         }
         #system-message-preview {
         color: #666;
         font-style: italic;
         }
         /* Model Selection Styles */
         .model-selection {
         margin-bottom: 20px;
         padding: 15px;
         background: white;
         border-radius: 10px;
         border: 1px solid #e1e5e9;
         }
         .model-options {
         display: grid;
         grid-template-columns: 1fr;
         gap: 10px;
         margin-top: 10px;
         }
         .model-option {
         padding: 12px;
         border: 2px solid #e1e5e9;
         border-radius: 8px;
         cursor: pointer;
         transition: all 0.3s ease;
         background: #f8f9fa;
         }
         .model-option:hover {
         border-color: #0078d7;
         background: #f0f7ff;
         }
         .model-option.selected {
         border-color: #0078d7;
         background: #e7f3ff;
         box-shadow: 0 2px 8px rgba(0, 120, 215, 0.2);
         }
         .model-option.disabled {
         opacity: 0.6;
         cursor: not-allowed;
         }
         .model-name {
         font-weight: 600;
         margin-bottom: 5px;
         color: #333;
         }
         .model-provider {
         font-size: 0.8rem;
         color: #666;
         margin-bottom: 5px;
         }
         .model-description {
         font-size: 0.75rem;
         color: #888;
         line-height: 1.3;
         }
         .current-model {
         background: #e7f3ff;
         padding: 8px 12px;
         border-radius: 6px;
         margin-top: 10px;
         font-size: 0.9rem;
         border-left: 3px solid #0078d7;
         }
         /* RAG Toggle Styles */
         .rag-toggle-section {
         margin-bottom: 20px;
         padding: 15px;
         background: white;
         border-radius: 10px;
         border: 1px solid #e1e5e9;
         }
         .toggle-container {
         margin-top: 10px;
         }
         .toggle-label {
         display: flex;
         justify-content: space-between;
         align-items: center;
         cursor: pointer;
         font-weight: 500;
         }
         .toggle-switch {
         position: relative;
         display: inline-block;
         width: 50px;
         height: 24px;
         }
         .toggle-switch input {
         opacity: 0;
         width: 0;
         height: 0;
         }
         .toggle-slider {
         position: absolute;
         cursor: pointer;
         top: 0;
         left: 0;
         right: 0;
         bottom: 0;
         background-color: #ccc;
         transition: .4s;
         border-radius: 24px;
         }
         .toggle-slider:before {
         position: absolute;
         content: "";
         height: 16px;
         width: 16px;
         left: 4px;
         bottom: 4px;
         background-color: white;
         transition: .4s;
         border-radius: 50%;
         }
         input:checked + .toggle-slider {
         background-color: #0078d7;
         }
         input:checked + .toggle-slider:before {
         transform: translateX(26px);
         }
         .rag-status {
         margin-top: 10px;
         padding: 8px 12px;
         background: #f8f9fa;
         border-radius: 5px;
         font-size: 0.9rem;
         }
         .status-enabled {
         color: #107c10;
         font-weight: 600;
         }
         .status-disabled {
         color: #d13438;
         font-weight: 600;
         }
         .rag-info {
         margin-top: 8px;
         font-size: 0.8rem;
         color: #666;
         line-height: 1.4;
         }
         /* Upload Section Styles */
         .upload-section {
         margin-bottom: 20px;
         }
         .upload-area {
         border: 2px dashed #0078d7;
         border-radius: 10px;
         padding: 20px;
         text-align: center;
         margin-bottom: 15px;
         background: #f8fbff;
         transition: all 0.3s ease;
         }
         .upload-area:hover {
         border-color: #106ebe;
         background: #f0f7ff;
         }
         .upload-area.dragover {
         border-color: #107c10;
         background: #f0fff0;
         }
         .file-input {
         display: none;
         }
         .file-label {
         display: block;
         cursor: pointer;
         color: #0078d7;
         font-weight: 600;
         }
         .file-info {
         font-size: 0.8rem;
         color: #666;
         margin-top: 10px;
         }
         .query-all-container {
         margin-top: 10px;
         text-align: center;
         }
         .query-all-container .action-btn {
         width: 100%;
         }
         /* PDF List Styles */
         .pdf-list {
         margin-top: 20px;
         }
         .pdf-item {
         background: white;
         border: 1px solid #e1e5e9;
         border-radius: 8px;
         padding: 12px;
         margin-bottom: 10px;
         display: flex;
         justify-content: space-between;
         align-items: center;
         cursor: pointer;
         transition: all 0.3s ease;
         }
         .pdf-item:hover {
         border-color: #0078d7;
         background: #f0f7ff;
         }
         .pdf-info {
         flex: 1;
         }
         .pdf-name {
         font-weight: 600;
         margin-bottom: 5px;
         font-size: 0.9rem;
         }
         .pdf-meta {
         font-size: 0.75rem;
         color: #666;
         }
         .pdf-actions {
         display: flex;
         gap: 5px;
         }
         .action-btn {
         padding: 6px 10px;
         font-size: 0.8rem;
         background: #f8f9fa;
         border: 1px solid #e1e5e9;
         }
         .action-btn:hover {
         background: #e9ecef;
         }
         .active-pdf {
         border-color: #0078d7;
         background: #f0f7ff;
         box-shadow: 0 2px 8px rgba(0, 120, 215, 0.2);
         }
         /* Status and Info Styles */
         .status-info {
         padding: 10px;
         background: #fff3cd;
         border: 1px solid #ffeaa7;
         border-radius: 5px;
         margin-bottom: 15px;
         font-size: 0.9rem;
         }
         .no-pdfs-message {
         text-align: center;
         color: #666;
         font-style: italic;
         margin-top: 20px;
         }
         /* Error and Source Styles */
         .error-message {
         background: #f8d7da;
         color: #721c24;
         border: 1px solid #f5c6cb;
         text-align: center;
         }
         .source-documents {
         margin-top: 10px;
         padding: 10px;
         background: #f8f9fa;
         border-radius: 5px;
         border-left: 3px solid #0078d7;
         }
         .source-title {
         font-weight: 600;
         margin-bottom: 5px;
         color: #0078d7;
         font-size: 0.9rem;
         }
         .source-text {
         font-size: 0.85rem;
         color: #666;
         line-height: 1.4;
         margin-bottom: 8px;
         padding: 8px;
         background: white;
         border-radius: 4px;
         border-left: 2px solid #e1e5e9;
         }
         .system-message-indicator {
         margin-top: 10px;
         padding: 8px;
         background: #e7f3ff;
         border-radius: 5px;
         font-size: 0.8rem;
         color: #666;
         border-left: 3px solid #6f42c1;
         }
         .rag-mode-indicator {
         display: inline-block;
         padding: 4px 8px;
         border-radius: 12px;
         font-size: 0.7rem;
         font-weight: 600;
         margin-left: 8px;
         }
         .rag-enabled {
         background: #d4edda;
         color: #155724;
         border: 1px solid #c3e6cb;
         }
         .rag-disabled {
         background: #f8d7da;
         color: #721c24;
         border: 1px solid #f5c6cb;
         }
         /* Scrollbar Styling */
         .messages-container::-webkit-scrollbar,
         .sidebar::-webkit-scrollbar {
         width: 6px;
         }
         .messages-container::-webkit-scrollbar-track,
         .sidebar::-webkit-scrollbar-track {
         background: #f1f1f1;
         border-radius: 3px;
         }
         .messages-container::-webkit-scrollbar-thumb,
         .sidebar::-webkit-scrollbar-thumb {
         background: #c1c1c1;
         border-radius: 3px;
         }
         .messages-container::-webkit-scrollbar-thumb:hover,
         .sidebar::-webkit-scrollbar-thumb:hover {
         background: #a8a8a8;
         }
         /* Responsive Design */
         @media (max-width: 768px) {
         body {
         padding: 10px;
         }
         .chat-container {
         height: 95vh;
         }
         .main-content {
         flex-direction: column;
         }
         .sidebar {
         width: 100%;
         max-height: 300px;
         }
         .message {
         max-width: 90%;
         }
         .input-container {
         flex-direction: column;
         }
         button {
         width: 100%;
         justify-content: center;
         }
         }
      </style>
   </head>
   <body>
      <div class="chat-container">
         <div class="chat-header">
            <h1>PDF Q&A Chat Agent</h1>
            <p>Upload PDFs and ask questions with custom system messages and RAG control</p>
         </div>
         <div class="main-content">
            <!-- Sidebar for PDF Management -->
            <div class="sidebar">
               <!-- System Message Section -->
               <div class="system-message-section">
                  <h3>‚öôÔ∏è System Message</h3>
                  <div class="status-info">
                     üí° Customize how the AI should behave and respond
                  </div>
                  <div class="system-message-area">
                     <textarea id="system-message-input" placeholder="Enter custom system message..." rows="4">You are a helpful assistant that answers questions based on provided PDF content.</textarea>
                     <div class="system-message-actions">
                        <button class="action-btn" onclick="updateSystemMessage()">
                        <span>üíæ</span> Save
                        </button>
                        <button class="action-btn" onclick="resetSystemMessage()">
                        <span>üîÑ</span> Reset
                        </button>
                     </div>
                     <div class="current-system-message" id="current-system-message">
                        <strong>Current:</strong> <span id="system-message-preview">You are a helpful assistant that answers questions based on provided PDF content.</span>
                     </div>
                  </div>
               </div>
               <!-- Model Selection Section -->
               <div class="model-selection">
                  <h3>ü§ñ AI Model</h3>
                  <div class="model-options" id="model-options">
                     <!-- Model options will be populated by JavaScript -->
                  </div>
                  <div class="current-model" id="current-model">
                     Selected: Loading...
                  </div>
               </div>
               <!-- RAG Toggle Section -->
               <div class="rag-toggle-section">
                  <h3>üîç RAG Mode</h3>
                  <div class="toggle-container">
                     <label class="toggle-label">
                        <span>Use PDF Context (RAG)</span>
                        <div class="toggle-switch">
                           <input type="checkbox" id="rag-toggle" checked>
                           <span class="toggle-slider"></span>
                        </div>
                     </label>
                  </div>
                  <div class="rag-status" id="rag-status">
                     Status: <span class="status-enabled">Enabled</span>
                  </div>
                  <div class="rag-info">
                     <strong>Enabled:</strong> Answers use your uploaded PDFs<br>
                     <strong>Disabled:</strong> Answers use model's general knowledge
                  </div>
               </div>
               <!-- Upload Section -->
               <div class="upload-section">
                  <h3>üìÅ Upload PDF</h3>
                  <div class="upload-area" id="upload-area">
                     <input type="file" id="pdf-file" class="file-input" accept=".pdf" multiple>
                     <label for="pdf-file" class="file-label">
                     <span>üìé Click to select PDF files or drag & drop here</span>
                     </label>
                     <p class="file-info">
                        Max file size: 10MB per file
                     </p>
                  </div>
                  <button class="upload-btn" onclick="uploadPDFs()">
                  <span>üöÄ</span> Upload & Process PDFs
                  </button>
                  <div class="query-all-container">
                     <button class="action-btn" onclick="setActivePDF(null)">
                     <span>üåê</span> Query All PDFs
                     </button>
                  </div>
               </div>
               <!-- PDF List -->
               <div class="pdf-list">
                  <h3>üìö Your PDFs</h3>
                  <div id="pdf-list-container">
                     <p class="no-pdfs-message">
                        No PDFs uploaded yet
                     </p>
                  </div>
               </div>
            </div>
            <!-- Chat Messages Area -->
            <div class="messages-container" id="messages">
               <div class="message bot-message">
                  <div class="message-sender">
                     <span>ü§ñ</span> PDF Assistant
                  </div>
                  <div class="message-bubble">
                     <div class="message-content">
                        Welcome! I can help you analyze PDF documents with full control over RAG mode. Here's what you can do:
                        <br><br>
                        <strong>1.</strong> Customize the system message to control how I respond
                        <br>
                        <strong>2.</strong> Choose your preferred AI model
                        <br>
                        <strong>3.</strong> Enable/disable PDF context (RAG mode)
                        <br>
                        <strong>4.</strong> Upload PDF files and ask questions
                        <br><br>
                        <strong>RAG Enabled:</strong> I'll search through your PDFs for answers<br>
                        <strong>RAG Disabled:</strong> I'll use my general knowledge
                        <br><br>
                        Start by customizing your settings!
                     </div>
                  </div>
               </div>
            </div>
         </div>
         <!-- Token Usage Bar -->
         <div class="token-usage" id="token-usage">
            <span>üìä</span> 
            PDFs: <span id="pdf-count">0</span> | 
            Active: <span id="active-pdf">All PDFs</span> | 
            Model: <span id="current-model-badge">Loading...</span> |
            RAG: <span id="rag-status-badge">Enabled</span>
         </div>
         <!-- Input Container -->
         <div class="input-container">
            <input type="text" id="user-input" placeholder="Ask a question about your PDFs..." autocomplete="off">
            <button class="send-btn" onclick="sendMessage()">
            <span>üì®</span> Send
            </button>
            <button class="reset-btn" onclick="resetChat()">
            <span>üîÑ</span> Reset Chat
            </button>
         </div>
      </div>
      <script>
         let uploadedPDFs = [];
         let activePDFId = null;
         let currentModel = 'huggingface';
         let availableModels = [];
         let currentSystemMessage = "You are a helpful assistant that answers questions based on provided PDF content.";
         let useRAG = true;
         
         // Initialize the application
         initializeApp();
         
         async function initializeApp() {
             await loadAvailableModels();
             await loadCurrentSettings();
             initializeDragAndDrop();
             await updatePDFList();
             setupEventListeners();
             
             // Load saved model preference
             const savedModel = localStorage.getItem('selectedModel');
             if (savedModel && availableModels.find(m => m.type === savedModel && m.is_available)) {
                 currentModel = savedModel;
                 renderModelOptions();
                 updateModelDisplay();
             }
             
             // Set up periodic refresh of PDF list
             setInterval(updatePDFList, 10000);
         }
         
         function setupEventListeners() {
             // RAG toggle event
             document.getElementById('rag-toggle').addEventListener('change', function() {
                 useRAG = this.checked;
                 updateRAGStatus();
                 updateRAGSetting();
             });
         
             // Enter key for system message input
             document.getElementById('system-message-input').addEventListener('keydown', function(e) {
                 if (e.ctrlKey && e.key === 'Enter') {
                     updateSystemMessage();
                 }
             });
         
             // Enter key for user input
             document.getElementById('user-input').addEventListener('keypress', function(event) {
                 if (event.key === 'Enter') {
                     sendMessage();
                 }
             });
         }
         
         async function loadCurrentSettings() {
             try {
                 const response = await fetch('/api/settings');
                 const settings = await response.json();
                 
                 currentSystemMessage = settings.system_message;
                 currentModel = settings.model_type;
                 useRAG = settings.use_rag;
                 
                 // Update UI
                 document.getElementById('system-message-input').value = currentSystemMessage;
                 document.getElementById('system-message-preview').textContent = currentSystemMessage;
                 document.getElementById('rag-toggle').checked = useRAG;
                 updateRAGStatus();
                 
             } catch (error) {
                 console.error('Error loading settings:', error);
             }
         }
         
         async function updateRAGSetting() {
             try {
                 const response = await fetch('/api/rag-status', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({
                         use_rag: useRAG
                     })
                 });
                 
                 if (response.ok) {
                     const status = useRAG ? 'enabled' : 'disabled';
                     addMessage(`‚úÖ RAG ${status} successfully`, 'bot', 'System');
                 } else {
                     throw new Error('Failed to update RAG status');
                 }
             } catch (error) {
                 console.error('Error updating RAG status:', error);
                 addMessage('‚ùå Failed to update RAG status', 'error', 'Error');
             }
         }
         
         async function updateModelSetting() {
             try {
                 const response = await fetch('/api/model-setting', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({
                         model_type: currentModel
                     })
                 });
                 
                 if (response.ok) {
                     console.log(`Model updated to: ${currentModel}`);
                     localStorage.setItem('selectedModel', currentModel);
                 }
             } catch (error) {
                 console.error('Error updating model setting:', error);
                 // Still save to localStorage as fallback
                 localStorage.setItem('selectedModel', currentModel);
             }
         }
         
         async function loadAvailableModels() {
             try {
                 const response = await fetch('/api/models');
                 const data = await response.json();
                 availableModels = data.models;
                 
                 // Set default model to first available one
                 const availableModel = availableModels.find(m => m.is_available);
                 if (availableModel && !currentModel) {
                     currentModel = availableModel.type;
                 }
                 
                 renderModelOptions();
                 updateModelDisplay();
             } catch (error) {
                 console.error('Error loading models:', error);
                 // Fallback models
                 availableModels = [
                     { name: 'Hugging Face', type: 'huggingface', provider: 'Hugging Face', description: 'Open-source models running via API', is_available: true },
                     { name: 'OpenAI GPT', type: 'openai', provider: 'OpenAI', description: 'GPT models via OpenAI API', is_available: false },
                     { name: 'Azure OpenAI', type: 'azure_openai', provider: 'Microsoft Azure', description: 'GPT models via Azure OpenAI service', is_available: false }
                 ];
                 renderModelOptions();
             }
         }
         
         function selectModel(modelType) {
             if (!availableModels.find(m => m.type === modelType)?.is_available) {
                 addMessage(`‚ùå ${getModelName(modelType)} is not available. Please check configuration.`, 'error', 'Error');
                 return;
             }
             
             currentModel = modelType;
             renderModelOptions();
             updateModelDisplay();
             updateModelSetting();
             addMessage(`üîÑ Switched to ${getModelName(currentModel)} model`, 'bot', 'System');
         }
         
         function renderModelOptions() {
             const container = document.getElementById('model-options');
             container.innerHTML = availableModels.map(model => `
                 <div class="model-option ${currentModel === model.type ? 'selected' : ''} ${!model.is_available ? 'disabled' : ''}" 
                      onclick="${model.is_available ? `selectModel('${model.type}')` : ''}">
                     <div class="model-name">
                         ${model.name}
                         ${!model.is_available ? ' <span style="color: #d13438; font-size: 0.7rem;">(Not configured)</span>' : ''}
                     </div>
                     <div class="model-provider">${model.provider}</div>
                     <div class="model-description">${model.description}</div>
                 </div>
             `).join('');
         }
         
         function updateModelDisplay() {
             document.getElementById('current-model').textContent = `Selected: ${getModelName(currentModel)}`;
             document.getElementById('current-model-badge').textContent = getModelName(currentModel);
         }
         
         function updateRAGStatus() {
             const statusElement = document.getElementById('rag-status');
             const badgeElement = document.getElementById('rag-status-badge');
             
             if (useRAG) {
                 statusElement.innerHTML = 'Status: <span class="status-enabled">Enabled</span>';
                 badgeElement.textContent = 'Enabled';
                 badgeElement.className = 'status-enabled';
             } else {
                 statusElement.innerHTML = 'Status: <span class="status-disabled">Disabled</span>';
                 badgeElement.textContent = 'Disabled';
                 badgeElement.className = 'status-disabled';
             }
         }
         
         function getModelName(modelType) {
             const model = availableModels.find(m => m.type === modelType);
             return model ? model.name : modelType;
         }
         
         // System Message Functions
         async function updateSystemMessage() {
             const systemMessageInput = document.getElementById('system-message-input');
             const newSystemMessage = systemMessageInput.value.trim();
             
             if (!newSystemMessage) {
                 alert('Please enter a system message.');
                 return;
             }
             
             try {
                 const response = await fetch('/api/system-message', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({
                         system_message: newSystemMessage
                     })
                 });
                 
                 if (response.ok) {
                     currentSystemMessage = newSystemMessage;
                     document.getElementById('system-message-preview').textContent = newSystemMessage;
                     addMessage('‚úÖ System message updated successfully', 'bot', 'System');
                 } else {
                     throw new Error('Failed to update system message');
                 }
             } catch (error) {
                 console.error('Error updating system message:', error);
                 addMessage('‚ùå Failed to update system message', 'error', 'Error');
             }
         }
         
         async function resetSystemMessage() {
             try {
                 const response = await fetch('/api/reset-system-message', {
                     method: 'POST'
                 });
                 
                 if (response.ok) {
                     const data = await response.json();
                     currentSystemMessage = data.system_message;
                     document.getElementById('system-message-input').value = currentSystemMessage;
                     document.getElementById('system-message-preview').textContent = currentSystemMessage;
                     addMessage('‚úÖ System message reset to default', 'bot', 'System');
                 } else {
                     throw new Error('Failed to reset system message');
                 }
             } catch (error) {
                 console.error('Error resetting system message:', error);
                 addMessage('‚ùå Failed to reset system message', 'error', 'Error');
             }
         }
         
         // File Upload Functions
         function initializeDragAndDrop() {
             const uploadArea = document.getElementById('upload-area');
             const fileInput = document.getElementById('pdf-file');
         
             uploadArea.addEventListener('dragover', (e) => {
                 e.preventDefault();
                 uploadArea.classList.add('dragover');
             });
         
             uploadArea.addEventListener('dragleave', () => {
                 uploadArea.classList.remove('dragover');
             });
         
             uploadArea.addEventListener('drop', (e) => {
                 e.preventDefault();
                 uploadArea.classList.remove('dragover');
                 const files = e.dataTransfer.files;
                 handleFileSelection(files);
             });
         
             fileInput.addEventListener('change', (e) => {
                 handleFileSelection(e.target.files);
             });
         }
         
         function handleFileSelection(files) {
             const pdfFiles = Array.from(files).filter(file => 
                 file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
             );
         
             if (pdfFiles.length === 0) {
                 alert('Please select PDF files only.');
                 return;
             }
         
             uploadedPDFs = [...uploadedPDFs, ...pdfFiles];
             showSelectedFiles();
         }
         
         function showSelectedFiles() {
             const uploadArea = document.getElementById('upload-area');
             if (uploadedPDFs.length > 0) {
                 uploadArea.innerHTML = `
                     <div style="text-align: center;">
                         <div style="font-size: 2rem; margin-bottom: 10px;">üìö</div>
                         <strong>${uploadedPDFs.length} PDF(s) selected:</strong>
                         <div style="font-size: 0.8rem; margin-top: 10px; text-align: left;">
                             ${uploadedPDFs.map(file => `‚Ä¢ ${file.name}`).join('<br>')}
                         </div>
                         <button class="action-btn" onclick="clearSelection()" style="margin-top: 10px;">
                             Clear Selection
                         </button>
                     </div>
                 `;
             }
         }
         
         function clearSelection() {
             uploadedPDFs = [];
             const uploadArea = document.getElementById('upload-area');
             uploadArea.innerHTML = `
                 <input type="file" id="pdf-file" class="file-input" accept=".pdf" multiple>
                 <label for="pdf-file" class="file-label">
                     <span>üìé Click to select PDF files or drag & drop here</span>
                 </label>
                 <p class="file-info">
                     Max file size: 10MB per file
                 </p>
             `;
             initializeDragAndDrop();
         }
         
         // FIXED UPLOAD FUNCTION - Uses correct endpoint and shows PDFs after upload
         async function uploadPDFs() {
             if (uploadedPDFs.length === 0) {
                 alert('Please select PDF files to upload.');
                 return;
             }
         
             addMessage(`Starting upload of ${uploadedPDFs.length} PDF(s) using ${getModelName(currentModel)}...`, 'bot', 'System');
         
             let successfulUploads = 0;
             let failedUploads = 0;
         
             // Upload files one by one
             for (const file of uploadedPDFs) {
                 const formData = new FormData();
                 formData.append('file', file);  // SINGULAR 'file' to match backend
                 formData.append('model_type', currentModel);
         
                 try {
                     addMessage(`üì§ Uploading: ${file.name}...`, 'bot', 'System');
                     
                     const response = await fetch('/api/upload-pdf', {  // CORRECT ENDPOINT
                         method: 'POST',
                         body: formData
                     });
         
                     if (!response.ok) {
                         const errorData = await response.json();
                         throw new Error(errorData.detail || `Upload failed with status ${response.status}`);
                     }
         
                     const data = await response.json();
                     successfulUploads++;
                     
                     addMessage(`‚úÖ ${file.name}: ${data.message}`, 'bot', 'System');
                     
                 } catch (error) {
                     failedUploads++;
                     addMessage(`‚ùå ${file.name}: ${error.message}`, 'error', 'Error');
                     console.error(`Upload failed for ${file.name}:`, error);
                 }
             }
         
             // Clear selection and update PDF list
             uploadedPDFs = [];
             clearSelection();
             await updatePDFList(); // Wait for list to refresh
         
             // Show final summary
             if (failedUploads === 0) {
                 addMessage(`üéâ All ${successfulUploads} PDF(s) uploaded successfully!`, 'bot', 'System');
             } else {
                 addMessage(`üìä Upload complete: ${successfulUploads} successful, ${failedUploads} failed`, 'bot', 'System');
             }
         }
         
         // PDF List Functions - KEEP THESE FOR PDF DISPLAY
         function updatePDFList() {
             const container = document.getElementById('pdf-list-container');
             
             fetch('/api/list-pdfs')
                 .then(response => response.json())
                 .then(data => {
                     if (data.pdfs && data.pdfs.length > 0) {
                         container.innerHTML = data.pdfs.map(pdf => `
                             <div class="pdf-item ${activePDFId === pdf.document_id ? 'active-pdf' : ''}" 
                                  onclick="setActivePDF('${pdf.document_id}')">
                                 <div class="pdf-info">
                                     <div class="pdf-name">${pdf.filename}</div>
                                     <div class="pdf-meta">
                                         ${pdf.document_count} chunks ‚Ä¢ ${new Date(pdf.upload_time).toLocaleDateString()}
                                         <br>Model: ${pdf.model_used || 'Hugging Face'}
                                     </div>
                                 </div>
                                 <div class="pdf-actions">
                                     <button class="action-btn" onclick="event.stopPropagation(); deletePDF('${pdf.document_id}')" title="Delete PDF">
                                         üóëÔ∏è
                                     </button>
                                 </div>
                             </div>
                         `).join('');
                     } else {
                         container.innerHTML = '<p class="no-pdfs-message">No PDFs uploaded yet</p>';
                     }
                     
                     document.getElementById('pdf-count').textContent = data.total_count || 0;
                     document.getElementById('active-pdf').textContent = 
                         activePDFId ? data.pdfs.find(p => p.document_id === activePDFId)?.filename || 'All PDFs' : 'All PDFs';
                 })
                 .catch(error => {
                     console.error('Error fetching PDF list:', error);
                 });
         }
         
         function setActivePDF(documentId) {
             activePDFId = documentId;
             updatePDFList();
             const pdfName = documentId ? 'Specific PDF' : 'All PDFs';
             addMessage(`üîç Now querying: ${pdfName}`, 'bot', 'System');
         }
         
         async function deletePDF(documentId) {
             if (!confirm('Are you sure you want to delete this PDF? This action cannot be undone.')) return;
         
             try {
                 const response = await fetch(`/api/delete-pdf/${documentId}`, {
                     method: 'DELETE'
                 });
         
                 if (response.ok) {
                     if (activePDFId === documentId) {
                         activePDFId = null;
                     }
                     updatePDFList();
                     addMessage('‚úÖ PDF deleted successfully', 'bot', 'System');
                 } else {
                     throw new Error('Delete failed');
                 }
             } catch (error) {
                 addMessage('‚ùå Failed to delete PDF', 'error', 'Error');
             }
         }
         
         // Chat Functions
         async function sendMessage() {
             const input = document.getElementById('user-input');
             const message = input.value.trim();
             
             if (!message) return;
         
             addMessage(message, 'user', 'You');
             input.value = '';
         
             const typingIndicator = addTypingIndicator();
         
             try {
                 const response = await fetch('/api/ask-question', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({
                         question: message,
                         document_id: activePDFId,
                         model_type: currentModel,
                         system_message: currentSystemMessage,
                         use_rag: useRAG,
                         top_k: 3
                     })
                 });
         
                 const data = await response.json();
         
                 typingIndicator.remove();
         
                 if (!response.ok) {
                     addMessage(data.detail || 'An error occurred while processing your request.', 'error', 'Error');
                     return;
                 }
         
                 let formattedResponse = formatResponse(data.answer);
                 
                 const ragBadge = data.rag_enabled ? 
                     '<span class="rag-mode-indicator rag-enabled">RAG</span>' : 
                     '<span class="rag-mode-indicator rag-disabled">Direct</span>';
                 
                 formattedResponse += `<div class="system-message-indicator">
                     ü§ñ Using: ${getModelName(data.model_used)} ${ragBadge} ‚Ä¢ 
                     Confidence: ${(data.confidence * 100).toFixed(1)}%
                 </div>`;
                 
                 if (data.rag_enabled && data.source_documents && data.source_documents.length > 0) {
                     formattedResponse += `<div class="source-documents">
                         <div class="source-title">üìö Source References:</div>
                         ${data.source_documents.map((doc, index) => 
                             `<div class="source-text"><strong>${index + 1}.</strong> ${doc}</div>`
                         ).join('')}
                     </div>`;
                 }
         
                 addMessage(formattedResponse, 'bot', 'PDF Assistant');
         
             } catch (error) {
                 typingIndicator.remove();
                 addMessage('‚ùå Network error: ' + error.message, 'error', 'Error');
                 console.error('Error:', error);
             }
         }
         
         function formatResponse(text) {
             if (!text) return '';
             
             return text
                 .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                 .replace(/\*(.*?)\*/g, '<em>$1</em>')
                 .replace(/\n/g, '<br>');
         }
         
         function addMessage(content, type, sender) {
             const messagesContainer = document.getElementById('messages');
             const messageDiv = document.createElement('div');
             
             if (type === 'user') {
                 messageDiv.className = 'message user-message';
             } else if (type === 'bot') {
                 messageDiv.className = 'message bot-message';
             } else {
                 messageDiv.className = 'message bot-message error-message';
             }
             
             const senderDiv = document.createElement('div');
             senderDiv.className = 'message-sender';
             
             if (type === 'user') {
                 senderDiv.innerHTML = '<span>üë§</span> ' + sender;
             } else if (type === 'bot') {
                 senderDiv.innerHTML = '<span>ü§ñ</span> ' + sender;
             } else {
                 senderDiv.innerHTML = '<span>‚ö†Ô∏è</span> ' + sender;
             }
             
             const bubbleDiv = document.createElement('div');
             bubbleDiv.className = 'message-bubble';
             
             const contentDiv = document.createElement('div');
             contentDiv.className = 'message-content';
             contentDiv.innerHTML = content;
             
             bubbleDiv.appendChild(contentDiv);
             messageDiv.appendChild(senderDiv);
             messageDiv.appendChild(bubbleDiv);
             messagesContainer.appendChild(messageDiv);
             
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
             
             return messageDiv;
         }
         
         function addTypingIndicator() {
             const messagesContainer = document.getElementById('messages');
             const messageDiv = document.createElement('div');
             messageDiv.className = 'message bot-message';
             
             const senderDiv = document.createElement('div');
             senderDiv.className = 'message-sender';
             senderDiv.innerHTML = '<span>ü§ñ</span> PDF Assistant';
             
             const bubbleDiv = document.createElement('div');
             bubbleDiv.className = 'message-bubble';
             
             const typingDiv = document.createElement('div');
             typingDiv.className = 'typing-indicator';
             typingDiv.innerHTML = 'Analyzing PDF content' + 
                 '<div class="typing-dots">' +
                 '<div class="typing-dot"></div>' +
                 '<div class="typing-dot"></div>' +
                 '<div class="typing-dot"></div>' +
                 '</div>';
             
             bubbleDiv.appendChild(typingDiv);
             messageDiv.appendChild(senderDiv);
             messageDiv.appendChild(bubbleDiv);
             messagesContainer.appendChild(messageDiv);
             
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
             
             return messageDiv;
         }
         
         function resetChat() {
             if (confirm('Are you sure you want to reset the chat? All conversation history will be lost.')) {
                 document.getElementById('messages').innerHTML = `
                     <div class="message bot-message">
                         <div class="message-sender">
                             <span>ü§ñ</span> PDF Assistant
                         </div>
                         <div class="message-bubble">
                             <div class="message-content">
                                 Chat has been reset. You can continue asking questions about your uploaded PDFs.
                             </div>
                         </div>
                     </div>
                 `;
             }
         }
      </script>
   </body>
</html>